<div class="col-sm-3 col-md-2 sidebar">
  <ul class="nav nav-sidebar">
    <li><a href="/">Overview</a></li>
    <li class="active"><a href="/factoid">Factoid Database</a></li>
    <li><a href="/ban">Ban Management</a></li>
    <li><a href="/user">User Management</a></li>
    <li><a href="/bot">Bot Management</a></li>
  </ul>
</div>
<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
  <h2 class="sub-header">Factoid Management</h2>
  <div class="navbar navbar-default">
    <div class="container">
      <div class="navbar-header">
        <a class="navbar-brand">Factoid Database - <?php echo $this->game == null || !isset($this->gamelist[$this->game]) ? "All databases" : $this->gamelist[$this->game] ?></a>
      </div>
      <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
          <li></li>
          <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Select Database <b class="caret"></b></a>
            <ul id="dbListings" class="dropdown-menu">
            </ul>
          </li>
        </ul>
      </div><!--/.nav-collapse -->
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          <th style="width:50px">ID</th>
          <th style="width:200px">Name</th>
          <th style="width:200px"><?php
            if ($this->game == null) {
              echo 'Game';
            }
            ?></th>
          <th style="width:500px">Content</th>
          <th style="width:50px"><?php
            $display = false;
            foreach ($this->perms as $type => $perm):
              if ($perm) {
                $display = true;
              }
            endforeach;
            $display = true;
            if ($display) {
              echo 'Action';
            }
            ?></th>
        </tr>
      </thead>
      <tbody id="factoidtable">
      </tbody>
    </table>
  </div>
</div>

<script src="/js/bootstrap-editable.js"></script>

<script type="text/javascript">

  $.fn.editable.defaults.mode = 'inline';
  $('.editable-input').parents('form').removeClass('form-inline');

  $('.editbutton').click(function(e) {
    e.stopPropagation();
    toggleEditable("name", $(this).attr('data-factoid'), "text");
    toggleEditable("game", $(this).attr('data-factoid'), "text");
    toggleEditable("content", $(this).attr('data-factoid'), "textarea");
    $(this).hide();
    $('#savebutton_' + $(this).attr('data-factoid')).show();
  });

  $('.savebutton').click(function(e) {
    e.stopPropagation();
    toggleEditable("name", $(this).attr('data-factoid'), "text");
    toggleEditable("game", $(this).attr('data-factoid'), "text");
    toggleEditable("content", $(this).attr('data-factoid'), "textarea");
    $(this).hide();
    $('#editbutton_' + $(this).attr('data-factoid')).show();
  });

  $('#dbListings').append('<li id="loader"><a href="/">Loading</a></li>');

  var game = <?php echo $this->game == null || !isset($this->gamelist[$this->game]) ? "null" : $this->gamelist[$this->game] ?>;
  var perms = <?php echo json_encode($this->perms); ?>;
  var posting = $.post('factoid/get', {db: game}, "json");
  $('#factoidtable').hide();

  posting.done(function(data) {
    $('#loader').remove();
    $('#dbListings').append('<li><a href="/factoid">All</a></li>');

    var json = JSON.parse(data);
    var menu = $('#dbListings');

    for (var i = 0; i < json.games.length; i++) {
      menu.append('<li><a href="/factoid">' + json.games[i].displayname + '</a></li>');
    }
    var table = $("#factoidtable");
    var factoids = json.factoids;

    for (var i = 0; i < factoids.length; i++) {
      var factoid = factoids[i];
      table.append('<tr>');
      table.append('<td><em>' + factoid.id + '</em></td>');
      table.append('<td><strong id="name_' + factoid.id + '" data-pk="' + factoid.id + '">' + factoid.name + '</strong></td>');

      if (game === null) {
        table.append('<td><p id="game_' + factoid.id + '" data-pk="' + factoid.id + '">' + factoid.game + '</p></td>');
      }

      table.append('<td><p id="content_' + factoid.id + '" data-pk="' + factoid.id + '">' + factoid.content + '</p></td>');
      table.append('<td>');

      if (perms.edit) {
        table.append('<button id="editbutton_' + factoid.id + '" data-factoid="' + factoid.id + '" type="button" class="btn btn-xs btn-warning editbutton">Edit</button>');
        table.append('<button id="savebutton_' + factoid.id + '" data-factoid="' + factoid.id + '" type="button" class="btn btn-xs btn-success savebutton">Save</button>');
        $('#savebutton_' + factoid.id).hide();
      }

      if (perms.delete) {
        table.append('<button id="deletebutton_' + factoid.id + '" data-factoid="' + factoid.id + '" type="button" class="btn btn-xs btn-danger">Delete</button>');
      }

      table.append('</td>');
      table.append('</tr>');
    }
    table.show();
    $('#progressbar').hide();
  });

  function toggleEditable(name, inputId, type) {
    var input = $('#' + name + "_" + inputId);
    if (!input.hasClass("editable")) {
      input.editable({
        highlight: false,
        toggle: 'manual',
        onblur: 'ignore',
        rows: 4,
        type: type,
        showbuttons: false,
        innerClass: 'editable-input-textarea'
      });
      input.editable('enable');
      input.editable('toggle');
    } else {
      input.editable('toggle');
      input.editable('disable');
      input.editable('destroy');
      input.css({display: 'block'});
    }
  }
</script>
